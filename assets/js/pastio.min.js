/* global ace */
/* global TogetherJS */

/**
 * Pastio
 * http://cixtor.com/
 * http://cixtor.com/pastio
 * https://github.com/cixtor/pastio
 *
 * Multi-platform desktop application built on top of node-webkit, node.js and a
 * public webservice maintained by cixtor.com to paste and visualize text/plain
 * files like source code, markdown files, plain text documents and publish them
 * public or privately for an unlimited time in a remote database and share those
 * files using a unique link identifier.
 */

jQuery(document).ready(function ($) {
    var Pastio = function () {
        this.editor = false;
        this.defaultMode = 'php';
        this.currentMode = '';
        this.visibility = 'public';
        this.defaultWordWrapping = false;
    };

    Pastio.prototype.initializeEditor = function () {
        var instance = this;

        instance.editor = ace.edit('pastioeditor');
        instance.editor.setTheme('ace/theme/monokai');
        instance.setEditorMode(instance.currentMode);
        instance.fillStatusBar();

        $('#pastio-new').on('click', function () {
            instance.editor.session.setValue('');

            return true;
        });

        this.bindSaveAction('#pastio-save');
        this.bindSyntaxAction('#pastio-syntax');
        this.bindLatestAction('#pastio-latest');

        $(document).delegate('.set-pastio-mode', 'click', function (e) {
            e.preventDefault();

            instance.setEditorMode($(this).data('mode'));

            $('#pastio-syntax').popover('hide');
        });

        $('#pastio-wordwrap').on('click', function (e) {
            e.preventDefault();

            var currentMode = $(this).data('wordwrap');
            var mode = (currentMode === 'true' ? false : true);

            instance.setWordWrapping(mode);
        });

        $('#pastio-together').on('click', function (e) {
            e.preventDefault();

            new TogetherJS(this);
        });

        $('.disabled-link').on('click', function (e) {
            e.preventDefault();
        });
    };

    Pastio.prototype.bindSaveAction = function (element) {
        var instance = this;

        $(element).on('click', function (event) {
            event.preventDefault();

            var dataJson = {
                code: instance.getEditorContent(),
                mode: instance.currentMode,
                visibility: instance.visibility
            };

            $.post('/save', dataJson, function (data) {
                if (data.status === 1) {
                    instance.editor.setValue('');
                }

                $('#pastio-modal .modal-header .modal-title').html(data.title);
                $('#pastio-modal .modal-body').html(data.content);
                $('#pastio-modal').modal('show');
                $('#pastio-modal').on('hidden.bs.modal', function () {
                    window.location.href = data.url;
                });
            });
        });
    };

    Pastio.prototype.bindSyntaxAction = function (element) {
        $(element).on('click', function (event) {
            event.preventDefault();

            $.post('/get_modes', function (data) {
                var modeList = '';

                $.each(data.modes, function (key, value) {
                    modeList += '<li><span class="set-pastio-mode" data-mode="' + value + '">' + value + '</span></li>';
                });

                $(element).unbind('click').popover({
                    title: 'Set syntax',
                    html: true,
                    placement: 'bottom',
                    trigger: 'click',
                    container: 'body',
                    content: '<ul class="pastio-syntax-list">' + modeList + '</ul>'
                }).popover('show');
            })
        });
    };

    Pastio.prototype.bindLatestAction = function (element) {
        $(element).on('click', function (event) {
            event.preventDefault();

            $.post('/latest_pastes', function (data) {
                $(element).unbind('click').popover({
                    title: 'Latest pastes',
                    html: true,
                    placement: 'bottom',
                    trigger: 'click',
                    container: 'body',
                    content: data,
                    template: '<div class="popover popover-latest-pastes">' +
                        '<div class="arrow"></div>' +
                        '<h3 class="popover-title"></h3>' +
                        '<div class="popover-content"></div>' +
                        '</div>'
                }).popover('show');

                $('.popover-latest-pastes span[data-toggle=tooltip]').tooltip();
            });
        });
    };

    Pastio.prototype.setEditorMode = function (mode) {
        mode = (mode === '' ? this.defaultMode : mode);
        this.editor.getSession().setMode('ace/mode/' + mode);
        this.currentMode = mode;

        $('#pastio-bottom .current-mode').html('Syntax: ' + mode);
    };

    Pastio.prototype.setWordWrapping = function (mode) {
        var localStorageKey = 'pastio-word-wrapping';

        try {
            if (mode === undefined) {
                var userChosen = localStorage.getItem(localStorageKey);

                if (userChosen === null) {
                    mode = this.defaultWordWrapping;
                } else {
                    mode = (userChosen === 'true' ? true : false);
                }
            }

            this.editor.getSession().setUseWrapMode(mode);
            localStorage.setItem('pastio-word-wrapping', mode);
        } catch (DOMException) {
            $('#pastio-bottom .container .pull-right').prepend('<li>[localStorage is disabled]</li>');
        }

        var wordWrappingState = (mode ? 'true' : 'false');

        $('#pastio-wordwrap').data('wordwrap', wordWrappingState);
        $('#pastio-bottom .word-wrapping').html('Word wrapping: ' + wordWrappingState);
    };

    Pastio.prototype.getEditorContent = function () {
        return this.editor.getValue();
    };

    Pastio.prototype.getEditorMode = function () {
        return this.editor.getSession().getMode();
    };

    Pastio.prototype.fillStatusBar = function () {
        var instance = this;
        var editor = instance.editor;

        editor.getSession().on('change', function () {
            var numberOfLines = instance.getNumberOfLines();

            $('#pastio-bottom .total-lines').html('Total lines: ' + numberOfLines);

            // var current_line = instance.getCurrentLine();
            // $('#pastio-bottom .current-line').html('Current line '+(current_line.row+1));
            // $('#pastio-bottom .column-number').html('Column '+(current_line.column+1));

            var numberOfChars = instance.getNumberOfChars();

            $('#pastio-bottom .total-chars').html('Chars: ' + numberOfChars);
        });

        instance.setWordWrapping();
    };

    Pastio.prototype.getNumberOfLines = function () {
        return this.editor.session.getLength();
    };

    Pastio.prototype.getCurrentLine = function () {
        return this.editor.selection.getCursor();
    };

    Pastio.prototype.getNumberOfChars = function () {
        return this.getEditorContent().length;
    };

    $('a[href^=#]').click(function (e) {
        e.preventDefault();
    });

    $('a[data-toggle=popover]').popover().click(function (e) {
        e.preventDefault();
    });

    $('a[data-toggle=tooltip], .creation-time').tooltip();

    new Pastio().initializeEditor();
});
